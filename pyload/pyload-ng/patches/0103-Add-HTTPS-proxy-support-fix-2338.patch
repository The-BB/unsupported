From 33fb3d28f63ff951c8fea62e460a6325008f3216 Mon Sep 17 00:00:00 2001
From: GammaC0de <gammac0de@users.noreply.github.com>
Date: Sun, 20 Jun 2021 00:52:51 +0300
Subject: [PATCH 103/150] Add HTTPS proxy support (fix #2338)

---
 src/pyload/core/config/default.cfg           |  2 +-
 src/pyload/core/network/http/http_request.py | 12 +++++++++---
 src/pyload/core/network/request_factory.py   |  9 ++-------
 3 files changed, 12 insertions(+), 11 deletions(-)

--- a/src/pyload/core/config/default.cfg
+++ b/src/pyload/core/config/default.cfg
@@ -48,7 +48,7 @@ proxy - "Proxy":
     bool enabled : "Activated" = False
     ip host : "IP address" = localhost
     int port : "Port" = 7070
-    http;socks4;socks5 type : "Protocol" = http
+    http;https,socks4;socks5 type : "Protocol" = http
     str username : "Username" =
     password password : "Password" =
 log - "Log":
--- a/src/pyload/core/network/http/http_request.py
+++ b/src/pyload/core/network/http/http_request.py
@@ -16,6 +16,9 @@ from ..exceptions import Abort
 from .exceptions import BadHeader
 
 
+if not hasattr(pycurl, 'PROXYTYPE_HTTPS'):
+    pycurl.PROXYTYPE_HTTPS = 2
+
 def myquote(url):
     try:
         url = url.encode()
@@ -141,12 +144,15 @@ class HTTPRequest:
             self.c.setopt(pycurl.INTERFACE, interface)
 
         if proxy:
-            if proxy["type"] == "socks4":
+            if proxy["type"] == "http":
+                self.c.setopt(pycurl.PROXYTYPE, pycurl.PROXYTYPE_HTTP)
+            elif proxy["type"] == "https":
+                self.c.setopt(pycurl.PROXYTYPE, pycurl.PROXYTYPE_HTTPS)
+                self.c.setopt(pycurl.PROXY_SSL_VERIFYPEER, 0)
+            elif proxy["type"] == "socks4":
                 self.c.setopt(pycurl.PROXYTYPE, pycurl.PROXYTYPE_SOCKS4)
             elif proxy["type"] == "socks5":
                 self.c.setopt(pycurl.PROXYTYPE, pycurl.PROXYTYPE_SOCKS5)
-            else:
-                self.c.setopt(pycurl.PROXYTYPE, pycurl.PROXYTYPE_HTTP)
 
             self.c.setopt(pycurl.PROXY, proxy["host"])
             self.c.setopt(pycurl.PROXYPORT, int(proxy["port"]))
--- a/src/pyload/core/network/request_factory.py
+++ b/src/pyload/core/network/request_factory.py
@@ -79,12 +79,7 @@ class RequestFactory:
         if not self.pyload.config.get("proxy", "enabled"):
             return {}
         else:
-            type = "http"
-            setting = self.pyload.config.get("proxy", "type").lower()
-            if setting == "socks4":
-                type = "socks4"
-            elif setting == "socks5":
-                type = "socks5"
+            proxy_type = self.pyload.config.get("proxy", "type").lower()
 
             username = None
             if (
@@ -101,7 +96,7 @@ class RequestFactory:
                 pw = self.pyload.config.get("proxy", "password")
 
             return {
-                "type": type,
+                "type": proxy_type,
                 "host": self.pyload.config.get("proxy", "host"),
                 "port": self.pyload.config.get("proxy", "port"),
                 "username": username,
