From e23637fc48f8e9951b7329ec07866f6fadd2fd40 Mon Sep 17 00:00:00 2001
From: GammaC0de <gammac0de@users.noreply.github.com>
Date: Sat, 15 May 2021 18:48:35 +0300
Subject: [PATCH 040/150] [NitroflareCom] sync with stable

---
 .../plugins/downloaders/NitroflareCom.py      | 42 ++++++++++++-------
 1 file changed, 26 insertions(+), 16 deletions(-)

--- a/src/pyload/plugins/downloaders/NitroflareCom.py
+++ b/src/pyload/plugins/downloaders/NitroflareCom.py
@@ -5,16 +5,17 @@ import re
 
 from pyload.core.network.request_factory import get_url
 
+from ..anticaptchas.ReCaptcha import ReCaptcha
 from ..base.simple_downloader import SimpleDownloader
 
 
 class NitroflareCom(SimpleDownloader):
     __name__ = "NitroflareCom"
     __type__ = "downloader"
-    __version__ = "0.27"
+    __version__ = "0.30"
     __status__ = "testing"
 
-    __pattern__ = r"https?://(?:www\.)?nitroflare\.com/view/(?P<ID>[\w^_]+)"
+    __pattern__ = r"https?://(?:www\.)?(?:nitro\.download|nitroflare\.com)/view/(?P<ID>[\w^_]+)"
     __config__ = [
         ("enabled", "bool", "Activated", True),
         ("use_premium", "bool", "Use premium account if available", True),
@@ -36,12 +37,13 @@ class NitroflareCom(SimpleDownloader):
     OFFLINE_PATTERN = r">File doesn\'t exist"
 
     LINK_PATTERN = r'(https?://[\w\-]+\.nitroflare\.com/.+?)"'
-    FILE_ID_PATTERN = r"https?://(?:www\.)?nitroflare\.com/view/(?P<ID>[\w^_]+)"
+
     DIRECT_LINK = False
 
     PREMIUM_ONLY_PATTERN = r"This file is available with Premium only"
-    WAIT_PATTERN = r"You have to wait (\d+ minutes)"
-    # ERROR_PATTERN        = r'downloading is not possible'
+    DL_LIMIT_PATTERN = r"You have to wait \d+ minutes to download your next file."
+
+    URL_REPLACEMENTS = [(r"nitro\.download", "nitroflare.com")]
 
     @classmethod
     def api_info(cls, url):
@@ -49,11 +51,7 @@ class NitroflareCom(SimpleDownloader):
         file_id = re.search(cls.__pattern__, url).group("ID")
 
         data = json.loads(
-            get_url(
-                "https://nitroflare.com/api/v2/getFileInfo",
-                get={"files": file_id},
-                decode=True,
-            )
+            get_url("https://nitroflare.com/api/v2/getFileInfo", get={"files": file_id})
         )
 
         if data["type"] == "success":
@@ -76,9 +74,12 @@ class NitroflareCom(SimpleDownloader):
         try:
             wait_time = int(re.search(r"var timerSeconds = (\d+);", self.data).group(1))
 
-        except Exception:
+        except (IndexError, ValueError):
             wait_time = 120
 
+        recaptcha = ReCaptcha(pyfile)
+        recaptcha_key = recaptcha.detect_key()
+
         self.data = self.load(
             "http://nitroflare.com/ajax/freeDownload.php",
             post={"method": "startTimer", "fileId": self.info["pattern"]["ID"]},
@@ -88,15 +89,24 @@ class NitroflareCom(SimpleDownloader):
 
         self.set_wait(wait_time)
 
-        response = self.captcha.decrypt(
-            "http://nitroflare.com/plugins/cool-captcha/captcha.php"
-        )
+        inputs = {"method": "fetchDownload"}
+
+        if recaptcha_key:
+            self.captcha = recaptcha
+            response, _ = self.captcha.challenge(recaptcha_key)
+            inputs["g-recaptcha-response"] = response
+
+        else:
+            response = self.captcha.decrypt(
+                "http://nitroflare.com/plugins/cool-captcha/captcha.php"
+            )
+
+        inputs["captcha"] = response
 
         self.wait()
 
         self.data = self.load(
-            "http://nitroflare.com/ajax/freeDownload.php",
-            post={"method": "fetchDownload", "captcha": response},
+            "http://nitroflare.com/ajax/freeDownload.php", post=inputs
         )
 
         if "The captcha wasn't entered correctly" in self.data:
