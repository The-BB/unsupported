From 78dc8f94c98d694b5405ff9d1cb378df92a3f2fc Mon Sep 17 00:00:00 2001
From: GammaC0de <gammac0de@users.noreply.github.com>
Date: Sat, 25 Dec 2021 23:30:45 +0200
Subject: [PATCH 61/73] [FshareVn] fix #4057

---
 src/pyload/plugins/accounts/FshareVn.py    |  4 ++--
 src/pyload/plugins/downloaders/FshareVn.py | 19 +++++++++++--------
 2 files changed, 13 insertions(+), 10 deletions(-)

diff --git a/src/pyload/plugins/accounts/FshareVn.py b/src/pyload/plugins/accounts/FshareVn.py
index 0b2563d10..28df0f2f5 100644
--- a/src/pyload/plugins/accounts/FshareVn.py
+++ b/src/pyload/plugins/accounts/FshareVn.py
@@ -10,7 +10,7 @@ from ..base.account import BaseAccount
 class FshareVn(BaseAccount):
     __name__ = "FshareVn"
     __type__ = "account"
-    __version__ = "0.26"
+    __version__ = "0.27"
     __status__ = "testing"
 
     __description__ = """Fshare.vn account plugin"""
@@ -26,7 +26,7 @@ class FshareVn(BaseAccount):
 
     # See https://www.fshare.vn/api-doc
     def api_request(self, method, session_id=None, **kwargs):
-        self.req.http.c.setopt(pycurl.USERAGENT, "pyLoad-XBEMRN")
+        self.req.http.c.setopt(pycurl.USERAGENT, "pyLoad-B1RS5N")
 
         if len(kwargs) == 0:
             json_data = self.load(
diff --git a/src/pyload/plugins/downloaders/FshareVn.py b/src/pyload/plugins/downloaders/FshareVn.py
index 5e7917877..962e2f5ea 100644
--- a/src/pyload/plugins/downloaders/FshareVn.py
+++ b/src/pyload/plugins/downloaders/FshareVn.py
@@ -12,7 +12,7 @@ from ..base.simple_downloader import SimpleDownloader
 class FshareVn(SimpleDownloader):
     __name__ = "FshareVn"
     __type__ = "downloader"
-    __version__ = "0.35"
+    __version__ = "0.36"
     __status__ = "testing"
 
     __pattern__ = r"https?://(?:www\.)?fshare\.vn/file/(?P<ID>\w+)"
@@ -40,7 +40,7 @@ class FshareVn(SimpleDownloader):
 
     # See https://www.fshare.vn/api-doc
     def api_request(self, method, session_id=None, **kwargs):
-        self.req.http.c.setopt(pycurl.USERAGENT, "pyLoad-XBEMRN")
+        self.req.http.c.setopt(pycurl.USERAGENT, "pyLoad-B1RS5N")
 
         if len(kwargs) == 0:
             json_data = self.load(
@@ -48,7 +48,7 @@ class FshareVn(SimpleDownloader):
                 cookies=[("fshare.vn", "session_id", session_id)]
                 if session_id
                 else True,
-                )
+            )
 
         else:
             self.req.http.c.setopt(
@@ -60,7 +60,7 @@ class FshareVn(SimpleDownloader):
                 cookies=[("fshare.vn", "session_id", session_id)]
                 if session_id
                 else True,
-                )
+            )
 
         return json.loads(json_data)
 
@@ -68,15 +68,15 @@ class FshareVn(SimpleDownloader):
         info = {}
         file_id = re.match(self.__pattern__, url).group("ID")
 
-        self.req.c.setopt(pycurl.HTTPHEADER, ["Accept: application/json, text/plain, */*"])
+        self.req.http.c.setopt(
+            pycurl.HTTPHEADER, ["Accept: application/json, text/plain, */*"]
+        )
         file_info = json.loads(
             self.load(
                 "https://www.fshare.vn/api/v3/files/folder", get={"linkcode": file_id}
             )
         )
 
-        req.close()
-
         if file_info.get("status") == 404:
             info["status"] = 1
 
@@ -120,13 +120,16 @@ class FshareVn(SimpleDownloader):
         try:
             json_data = json.loads(self.data)
 
-        except Exception:
+        except ValueError:
             self.fail(self._("Expected JSON data"))
 
         err_msg = json_data.get("msg")
         if err_msg:
             self.fail(err_msg)
 
+        elif json_data.get("policydowload", False):
+            self.fail(self._("File can be downloaded by premium users only"))
+
         elif "url" not in json_data:
             self.fail(self._("Unexpected response"))
 
-- 
2.30.2

