From cdc11a4329fcf47d1add94021a974c03fbe4d93f Mon Sep 17 00:00:00 2001
From: GammaC0de <gammac0de@users.noreply.github.com>
Date: Mon, 25 Oct 2021 23:49:00 +0300
Subject: [PATCH 03/73] [MegaupNet] fix #4023

---
 src/pyload/plugins/downloaders/MegaupNet.py | 50 +++++++++++++++++++--
 1 file changed, 46 insertions(+), 4 deletions(-)

diff --git a/src/pyload/plugins/downloaders/MegaupNet.py b/src/pyload/plugins/downloaders/MegaupNet.py
index 53a9ba9a2..36c7ddc3e 100644
--- a/src/pyload/plugins/downloaders/MegaupNet.py
+++ b/src/pyload/plugins/downloaders/MegaupNet.py
@@ -1,14 +1,16 @@
 # -*- coding: utf-8 -*-
 
+import json
 import re
 
 from ..base.simple_downloader import SimpleDownloader
+from pyload.core.utils.misc import eval_js
 
 
 class MegaupNet(SimpleDownloader):
     __name__ = "MegaupNet"
     __type__ = "downloader"
-    __version__ = "0.02"
+    __version__ = "0.03"
     __status__ = "testing"
 
     __pattern__ = r"https?://megaup.net/.+"
@@ -27,10 +29,50 @@ class MegaupNet(SimpleDownloader):
     NAME_PATTERN = r"File: (?P<N>.+?)<"
     SIZE_PATTERN = r"Size: (?P<S>[\d.,]+) (?P<U>[\w^_]+)"
 
-    OFFLINE_PATTERN = r"^unmatchable$"
+    OFFLINE_PATTERN = r"The file you are trying to download is no longer available!"
     WAIT_PATTERN = r"var seconds = (\d+);"
+    LINK_PATTERN = r'window.location.replace\("(.+?)"\)'
 
     def handle_free(self, pyfile):
-        m = re.search(r"\'(https://megaup\.net/\w+\?pt=.+?)\'", self.data)
+        s = [
+            x
+            for x in re.findall(r"<script[\s\S]*?>([\s\S]*?)</script>", self.data, re.I)
+            if "function DeObfuscate_String_and_Create_Form_With_Mhoa_URL" in x
+        ]
+        if len(s) != 1:
+            self.fail(self._("deobfuscate function not found"))
+
+        init = """window = {
+                    innerWidth: 1280,
+                    innerHeight: 567,
+                  };
+                  var document = {
+                    documentElement: {clientWidth: 1280, clientHeight: 567},
+                    body: {clientWidth: 1280, clientHeight: 567}
+                  };"""
+        deobfuscate_script = init + s[0]
+        deobfuscate_script = re.sub(
+            r"if\s*\(width_trinh_duyet[\s\S]*",
+            "return JSON.stringify({idurl:url_da_encrypt, idfilename:FileName, idfilesize:FileSize})};",
+            deobfuscate_script,
+        )
+
+        m = re.search(
+            r"if \(seconds == 0\)[\s\S]+?(DeObfuscate_String_and_Create_Form_With_Mhoa_URL\(.+?\);)",
+            self.data,
+        )
+        if m is None:
+            self.fail(self._("deobfuscate function call not found"))
+
+        deobfuscate_script += m.group(1)
+        json_data = eval_js(deobfuscate_script)
+
+        if not json_data.startswith("{"):
+            self.fail(self._("Unexpected response, expected JSON data"))
+
+        params = json.loads(json_data)
+
+        self.data = self.load("https://download.megaup.net/", get=params)
+        m = re.search(self.LINK_PATTERN, self.data)
         if m is not None:
-            self.download(m.group(1), ref=pyfile.url)
+            self.link = m.group(1)
-- 
2.30.2

